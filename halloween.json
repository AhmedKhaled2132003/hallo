function runHalloweenScript() {
  'use strict';

  function waitForGameReady() {
    return new Promise((resolve) => {
      const check = setInterval(() => {
        if (
          unsafeWindow?.micro?.NetManager &&
          unsafeWindow?.NetUtils &&
          unsafeWindow?.GF?.loginModel
        ) {
          clearInterval(check);
          resolve();
        }
      }, 500);
    });
  }

  function disableProtection() {
    try {
      unsafeWindow.micro.NetManager.prototype.isAmfOk = function () {
        return true;
      };
      unsafeWindow.micro.NetManager.prototype.getErrorMsg = function () {
        return true;
      };
      console.log('✅ تم تعطيل حماية الأحداث');
    } catch (e) {
      console.warn('❌ فشل في تعطيل الحماية:', e);
    }
  }

  async function start() {
    await waitForGameReady();
    disableProtection();

    const menu = document.createElement('button');
    menu.innerText = 'أحمد خالد';
    menu.onclick = async function () {
      const confirmStart = confirm('التشغيل التلقائى لإنهاء طلبات مهمة وقت مرح مع رجل الثلج\nتأكيد العملية؟');
      if (!confirmStart) return;

      const infoBox = document.createElement('div');
      infoBox.innerText = 'جارٍ إنهاء الطلبات تلقائياً - برمجة: أحمد خالد';
      infoBox.style.cssText = `
        position: fixed;
        top: 45px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid #aaa;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 12px;
        color: white;
        font-weight: bold;
        z-index: 9999;
        font-family: Arial;
      `;
      document.body.appendChild(infoBox);

      const net = unsafeWindow.NetUtils;
      const request = async (action, wid) => {
        return net.request('/Activity/HalloweenEvent', { action, wid });
      };

      while (true) {
        const points = unsafeWindow.GF.loginModel.getGiftsNumById(244884);
        infoBox.innerText = `جارٍ إنهاء الطلبات تلقائياً - لديك ⚪ ${points} نقطة - برمجة: أحمد خالد`;

        for (let wid = 1; wid <= 5; wid++) {
          await request('openWindow', wid);
          await request('refreshWindow', wid);
          await request('closeWindow', wid);
        }

        await new Promise((res) => setTimeout(res, 180000)); // 3 دقائق
      }
    };

    // زر التفعيل
    menu.style.cssText = `
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
      z-index: 9999;
      font-family: Arial;
    `;
    document.body.appendChild(menu);
  }

  start();
}

runHalloweenScript();
